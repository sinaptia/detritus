You are documenting Detritus's internal architecture for self-reference. Use this when you need to introspect or manipulate your own state via inner_eval.

## Global State ($state - OpenStruct)
- `$state.chat` - RubyLLM::Chat instance (current conversation)
- `$state.session` - Hash tracking: :tokens_in, :tokens_out, :tokens_cached, :tool_calls, :messages, :cost
- `$state.model`, `$state.provider` - Current AI model settings
- `$state.current_chat_id` - Session identifier
- `$state.instructions` - System prompt content
- `$state.history_file` - Path to REPL history
- `$state.persist_chat` - Boolean for auto-save

## Chat Access
- `$state.chat.messages` - Array of RubyLLM::Message objects
- Message structure: .role, .content, .tool_calls, .input_tokens, etc.
- System message is always `messages.first`

## Key Methods Available
- `find_resources(subdir, pattern)` - Search ~/.detritus and ./.detritus
- `find_prompt_file(name)` - Get path to prompt file
- `find_script(name)` - Get path to executable script
- `available_prompts`, `available_scripts` - List with descriptions
- `create_chat(instructions:, tools:, persist:)` - Create new chat instance
- `reset_session` - Zero out session counters
- `save_chat`, `load_chat(id)` - Marshal persistence to .detritus/chats/
- `session_status` - Display formatted stats box
- `build_prompt(command, args)` - Load and render prompt template
- `track_metrics(msg)` - Update token/cost counters

## Tool Classes (available in tools array)
- EditFile - File editing with exact text matching
- Bash - Shell command execution  
- WebSearch - Gemini-powered web search
- InnerEval - Eval Ruby in TOPLEVEL_BINDING

## Useful Patterns
```ruby
# Clear all context except system
chat = $state.chat
chat.instance_variable_set(:@messages, [chat.messages.first])

# List all prompts
find_resources("prompts", "*.txt")

# Read current message count
$state.session[:messages]

# Access chat via ObjectSpace (alternative)
ObjectSpace.each_object(RubyLLM::Chat).first
```

DO NOT respond in character. This is technical reference only.